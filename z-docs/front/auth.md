# Как происходит вход на платформу в HTML варианте?

## Шаг 1 - Яндекс

Если приглядеться к начальной странице [index.html](../../platform-gateway/src/main/resources/templates/index.html) - которая встречает нас на платформе,
можно заметить, что она по сути содержит просто ссылку на другую html страницу /crm/view/redirect с названием redirect. 
При нажатии на эту кнопку, и попытке перейти по ссылке - нас встретит фильтр авторизации Яндекс, который может редиректнуть на свой портал. 
Если подчинится этому редиректу - нас перебросит на портал яндекса, где пользователь вобьёт свои данные.

После того как пользователь войдёт через Яндекс - backend снова отправит на фронт 3** http код с редиректом на целевую страницу /crm/view/redirect.
На этом этапе браузер уже знает cookies и authorization для нашего пользователя.

Отныне и далее при запросах всегда следует использовать credentials: 'include' - так как все действия будут производиться под сессией Яндекса!

## Шаг 2 - Redirect.html

Мы попали на страницу /crm/view/redirect с вот таким содержимым: [redirect.html](../../crm-service/src/main/resources/templates/redirect.html).
Зачем мы здесь? Дело в том, что помимо авторизации через Яндекс, платформа может захотеть получить некоторые данные. А значит после входа необходимо удостовериться, что пользователь может попасть в ЛК, или отправить его на регистрацию.

Страница редирект нужна только для того, что вызвать метод POST /crm/api/v1/auth без тела, но с включением в запрос credentials:
```
fetch('/crm/api/v1/auth', {
        method: 'POST',
        credentials: 'include'
    })
```
Данный запрос вернёт нам классический ответ (statusCode + message) с определёнными кодами:
* 3000 - всё отлично, этот пользователь уже был на платформе, можно его пустить в личный кабинет и выполнять любые запросы
* 3001 - пользователю требуется регистрация (перенаправляем на страницу доп регистрации)
* 3002 - BLOCKED - перенаправить на страницу блока

Таким образом мы проверяем перед попаданием в ЛК, а может ли пользователь туда попасть. 
Важно понимать, что если пришли коды 3001 или 3002 - никакие апишки ЛК (такие как статистика и токены) работать не будут.
Они будут возвращать 3001/3002.

## Шаг 3 - Страница доп регистрации

Посмотрим на эту страницу: [registration.html](../../crm-service/src/main/resources/templates/registration.html)

На ней можно увидеть простую форму для ввода данных. 

После заполнения формы необходимо отправить запрос POST /crm/api/v1/auth/completeRegistration с телом и credentials (credentials очень нужны, так как регистрация проводится уже под аккаунтом Яндекса).

Запрос выглядит примерно вот так (nickName - поле из формы):
```
fetch('/crm/api/v1/auth/completeRegistration', {
            method: 'POST',
            credentials: 'include',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ nickName: nickname })
        })
```
Очень важно перед отправкой провалидировать telegram пользователя по параметрам <minlength="1" maxlength="32" pattern="^(a-zA-Zа-яА-Я0-9{1,32})$" required>

Ответом на этот запрос также является классическое statusCode и message с такими вариантами:
* 1001 - регистрация не удалось из-за проблемы. Нужно показать пользователю сообщение из message (например "Такой nickname уже существует")
* 3000 - всё отлично, этот пользователь уже был на платформе, можно его пустить в личный кабинет и выполнять любые запросы

ПОЛЬЗОВАТЕЛЬ ВОШЁЛ!

# Logout

Для того чтобы завершить сессию - нужно позвонить /logout
